<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="="UTF-8" />
    <meta name="geostats" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.8.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.8.0/addons/p5.dom.min.js"></script>
    <title>Geostats</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
      integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
      integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
      crossorigin=""
    ></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.3.0/dist/leaflet.markercluster.js"></script>
                                                                                             
     <!------------------------------------------MAP STYLES--------------------------------------------------------->                                                                                        
    <style>
      #mapMarkers {
        height: 400px;
        width: 800px;
      }
    </style>
    <style>
      #mapCountries {
        height: 400px;
        width: 800px;
      }
    </style>
  <!------------------------------------------MLEGEND STYLES--------------------------------------------------------->                                                                                        
                                                                                               
<style>
.info {
    padding: 6px 8px;
    font: 14px/16px Arial, Helvetica, sans-serif;
    background: white;
    background: rgba(255,255,255,0.8);
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px;
}
.info h4 {
    margin: 0 0 5px;
    color: #777;
}
 .legend {
    line-height: 18px;
    color: #555;
}
.legend i {
    width: 18px;
    height: 18px;
    float: left;
    margin-right: 8px;
    opacity: 0.7;
}                                                                                            
 </style>                                                                                             
     <!------------------------------------------TAB STYLES--------------------------------------------------------->                                                                                        
    <style>
     /* Style the tab */
.tab {
  overflow: hidden;
  border: 1px solid #ccc;
  background-color: #f1f1f1;
}

/* Style the buttons that are used to open the tab content */
.tab button {
  background-color: inherit;
  float: left;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 14px 16px;
  transition: 0.3s;
}

/* Change background color of buttons on hover */
.tab button:hover {
  background-color: #ddd;
}

/* Create an active/current tablink class */
.tab button.active {
  background-color: #ccc;
}

/* Style the tab content */
.tabcontent {
  display: none;
  padding: 6px 12px;
  border: 1px solid #ccc;
  border-top: none;
} 
                                                                                             
</style>
  </head>
                                                                                             
                                                                                             
                                                                                             
                                                                                             
                                                                                             
  <body>
                                                                                             
                                                                                             
    <!------------------------------------------INIT--------------------------------------------------------->
    <script src="buttons.js"></script>

    <!-- SELECT options for data filter-->
    <div id="selections">
      <select name="gameType" id="gameType">
        <option value="all">All game types</option>
      </select>
      <select name="timeLimit" id="timeLimit">
        <option value="all">All time limits</option>
      </select>
      <select name="mapName" id="mapName">
        <option value="all">All maps</option>
      </select>

      <button id="updateButton">UPDATE</button>
    </div>
                               
      <!------------------------------------------TABS--------------------------------------------------------->                          
     <!-- Tab links -->
<div class="tab">
  <button class="tablinks" onclick="openTab(event, 'Countries')" id="defaultOpen">Country stats</button>
  <button class="tablinks" onclick="openTab(event, 'Markers')">Individual rounds</button>
</div>

<!-- Tab content -->
<div id="Countries" class="tabcontent">
      <div id="mapCountries"></div>
    <div id="cStats"></div>
</div>

<div id="Markers" class="tabcontent">
  <div id="mapMarkers"></div>
    <div id="t5"></div>
    <div id="f5"></div>
</div>
                                                                 
                               
    

                    
                    
    <script>
  document.getElementById("defaultOpen").click();
                    
function openTab(evt, cityName) {
  // Declare all variables
  var i, tabcontent, tablinks;

  // Get all elements with class="tabcontent" and hide them
  tabcontent = document.getElementsByClassName("tabcontent");
  for (i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }

  // Get all elements with class="tablinks" and remove the class "active"
  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }

  // Show the current tab, and add an "active" class to the button that opened the tab
  document.getElementById(cityName).style.display = "block";
  evt.currentTarget.className += " active";
                                          
  mapC.invalidateSize();
  mapMark.invalidateSize();                                        
} 
</script>                

   <!------------------------------------------MAIN FUNCTION--------------------------------------------------------->
    <script>
      var markerList;

      var info = L.control();
      


      

      document
        .getElementById("updateButton")
        .addEventListener("click", loadData);
      
      loadData();                           

      async function loadData() {
        var divDebug = document.getElementById("gameType");
        var selectType = document.getElementById("gameType");
        var valueType = selectType.options[selectType.selectedIndex].value;

        var selectMap = document.getElementById("mapName");
        var valueMap = selectMap.options[selectMap.selectedIndex].value;

        var selectTime = document.getElementById("timeLimit");
        var valueTime = selectTime.options[selectTime.selectedIndex].value;

        const queryString = window.location.search;
        console.log(queryString);
        const urlParams = new URLSearchParams(queryString);
        const myId = urlParams.get("id");

        url =
          "/getdata?id=" +
          myId +
          "&type=" +
          valueType +
          "&map=" +
          valueMap +
          "&time=" +
          valueTime;
        var options = {
          method: "GET"
        };

        var response = await fetch(url, options);
        const dataObject = await response.json();
        const dataReturned = dataObject.list;
        const dataCountry = dataObject.countryStats;
        const dataGeoJSON = dataObject.geoData;

        var top5 = [];
        var mint5 = Math.min(5, dataReturned.length);
        console.log(mint5);
        for (var i = 0; i < mint5; i++) {
          top5.push(dataReturned[i]);
        }
        console.log(JSON.stringify(top5));
        var flop5 = [];
        var maxf5 = Math.max(0, dataReturned.length - 5);
        for (var i = dataReturned.length - 1; i > maxf5; i--) {
          flop5.push(dataReturned[i]);
        }

        var t5String = " BEST ROUNDS top 5 \n";
        for (var i = 0; i < top5.length; i++) {
          t5String = t5String.concat(
            top5[i].distanceInMeters +
              " m = " +
              top5[i].roundScore +
              " points in " +
              top5[i].time +
              " seconds at " +
              top5[i].address +
              "\n"
          );
        }

        document.getElementById("t5").innerHTML = t5String;

        var f5String = " WORST ROUNDS flop 5 \n";
        for (var i = 0; i < flop5.length; i++) {
          f5String = f5String.concat(
            flop5[i].distanceInMeters +
              " m = " +
              flop5[i].roundScore +
              " points in " +
              flop5[i].time +
              " seconds at " +
              flop5[i].address +
              "\n"
          );
        }
        console.log(flop5.length);
        document.getElementById("f5").innerHTML = f5String;

        document.getElementById("cStats").innerHTML = JSON.stringify(
          dataCountry
        );
        //console.log("geoJSON length" + dataGeoJSON.features.length);
        //console.log(dataGeoJSON);
                                      
        updategeojson(dataGeoJSON);
        updateMarkers(dataReturned);
      }
    </script>

    <!------------------------------------------COLORS--------------------------------------------------------->
    
    <script>
                                                                            
    function getcolor(number) {
        if (number < 0) { return "#ffffff"; }
        if (number < 500) { return "#d93030"; }
        if (number < 1000) { return "#d94130"; }
        if (number < 1500) { return "#d96830"; }
        if (number < 2000) { return "#d97930"; }
        if (number < 2250) { return "#d98a30"; }
        if (number < 2500) { return "#d99b30"; }
        if (number < 2750) { return "#d9a930"; }
        if (number < 3000) { return "#d9ba30"; }
        if (number < 3250) { return "#d9cb30"; }
        if (number < 3500) { return "#d9d930"; }
        if (number < 3750) { return "#c8d930"; }
        if (number < 4000) { return "#b7d930"; }
        if (number < 4200) { return "#a6d930"; }
        if (number < 4400) { return "#95d930"; }
        if (number < 4600) { return "#87d930"; }
        if (number < 4800) { return "#76d930"; }
        if (number < 4900) { return "#57d930"; }
        if (number < 4999) { return "#30d933"; }

        return "#00eeff";
      }
    </script>

    <!------------------------------------------MAP WITH MARKERS FUNCTIONS--------------------------------------------------------->
    <script>
      var mapMark;
      drawMap();
      function drawMap() {
        mapMark = L.map("mapMarkers").setView([15, 0], 2);
        const attribution =
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';

        const tileUrl = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
        const tiles = L.tileLayer(tileUrl, { attribution });
        tiles.addTo(mapMark);
      }





      function updateMarkers(data) {
        
        if (markerList) {
          markerList.clearLayers();
        }                
                        
        markerList = new L.layerGroup();

        for (var i = 0; i < data.length; i++) {
          var circleColor = getcolor(data[i].roundScore);
          var circle = L.circleMarker(
            [data[i].solutionLat, data[i].solutionLng],
            {
              color: circleColor,
              fillColor: circleColor,
              fillOpacity: 0.5,
              radius: 5
            }
          );

          circle.bindPopup(
            "Score : " + data[i].roundScore + "\n Address :" + data[i].address
          );
          markerList.addLayer(circle);
        }
        window.mapMark.addLayer(markerList);
      }

      

                        
                        
        
    </script>

    <!------------------------------------------MAP WITH COUNTRIES FUNCTIONS--------------------------------------------------------->
   

    <script>
      var mapC;
      var geoJSONLayer;
      var legend = L.control({position: 'bottomright'});                                                      
      drawMapC();
      
                       
      function drawMapC() {
        mapC = L.map("mapCountries").setView([15, 0], 2);
        const attribution =
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';
        const tileUrl = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
        const tiles = L.tileLayer(tileUrl, { attribution });
        tiles.addTo(mapC);
      }
                                                                            
                                                                            
                                                                            
    function updategeojson(data) {
        if (geoJSONLayer) {
          geoJSONLayer.clearLayers();
        }
        geoJSONLayer = new L.geoJson(data, {
          style: style,
          onEachFeature: onEachFeature
        });
        window.mapC.addLayer(geoJSONLayer);
      }
                                                                            
                                                                            
     function style(feature) {
        return {
          fillColor: getcolor(feature.properties.averageScore),
          weight: 2,
          opacity: 1,
          color: "white",
          dashArray: "3",
          fillOpacity: 0.7
        };
      }                                                                      
                                                                            
     info.onAdd = function(mapC) {
        this._div = L.DomUtil.create("div", "info"); // create a div with a class "info"
        this.update();
        return this._div;
      };

      function highlightFeature(e) {
        var layer = e.target;

        layer.setStyle({
          weight: 5,
          color: "#666",
          dashArray: "",
          fillOpacity: 0.7
        });

        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
          layer.bringToFront();
        }
      }

      function resetHighlight(e) {
        geoJSONLayer.resetStyle(e.target);
      }

      function onEachFeature(feature, layer) {
        //console.log(feature.properties.averageScore);
        var str = feature.properties.ADMIN + ": ";
        str +=   feature.properties.count + " rounds <br>";
        str +=  "avg score : " + feature.properties.averageScore + "<br>";
        //str +=  "avg distance : " + feature.properties.averageDistanceInMeters;
        str += "avg time : " + feature.properties.averageTime + "<br>";
        layer.bindPopup(
              str
        );
      }
                       
                       
      legend.onAdd = function (mapC) {

    var div = L.DomUtil.create('div', 'info legend');
        grades = [0,1000,2000,3000,4000,4500,5000];
        labels = [];
        div.innerHTML = "Average Score <br>";
    // loop through our density intervals and generate a label with a colored square for each interval
    for (var i = 0; i < grades.length-1; i++) {
        var str =  '<i style="background:' + getcolor(grades[i] + 1) + '"></i> ' + grades[i] + '&ndash;' + grades[i + 1] + '<br>';                    
        
      //var str =   '<i class="circle" style="background:' + getcolor(grades[i]) + '"></i> ';                                                                   
      console.log(str);
      div.innerHTML += str;
    }

    return div;
};   
    legend.addTo(mapC);
    </script>

    

  </body>
</html>
